{% extends "base.html" %}
{% block content %}

{% if wrong_owner %}
<div class="shrunk-messages">
    You are not the owner of this URL...
</div>
{% endif %}

<div class="row row-controls">
  <div class="col col-md-auto">
    <h2>URL Dashboard</h2>
  </div>

  {# Add Link dropdown menu #}
  <div class="col col-md-auto">
    <div class="dropdown">
      <button type="button" class="btn btn-primary dropdown-toggle"
	 data-toggle="dropdown" aria-expanded="false" onclick="clear_form(ADD_LINK_FORM)">
	<i class="fas fa-plus-circle"></i> Add Link
      </button>

      <div class="dropdown-menu create-org-dropdown">
	<form class="px-4 py-3 needs-validation" novalidate>
	  <div class="form-group row">
	    <input type="text" id="add-link-title" class="form-control" placeholder="Title"
		   onkeydown="send_request_keypress(event, ADD_LINK_FORM)">
	    <div id="add-link-title-feedback" class="invalid-feedback"></div>
	  </div>
	  <div class="form-group row">
	    <input type="text" id="add-link-long_url" class="form-control" placeholder="URL"
		   onkeydown="send_request_keypress(event, ADD_LINK_FORM)">
	    <div id="add-link-long_url-feedback" class="invalid-feedback"></div>
	  </div>

	  {% if "admin" in roles or "power_user" in roles %}
	  <div class="form-group row">
	    <input type="text" id="add-link-short_url" class="form-control"
		   placeholder="Alias (optional)"
		   onkeydown="send_request_keypress(event, ADD_LINK_FORM)">
	    <div id="add-link-short_url-feedback" class="invalid-feedback"></div>
	  </div>
	  {% endif %}

	  <button id="add-link-button" class="btn btn-primary" type="button"
		  onclick="send_request(ADD_LINK_FORM)">
	    Shrink
	  </button>
	</form>
      </div>
    </div>
  </div>

  {# Sort dropdown menu #}
  <div class="col col-md-auto">
    <div class="dropdown">
      <button class="btn btn-outline-primary dropdown-toggle btn-no-border btn-no-background bg-light"
	      type="button" data-toggle="dropdown"
	      aria-haspopup="true" aria-expanded="false">
	{% if sortby == "0" %}
	Newest first
	{% elif sortby == "1" %}
	Oldest first
	{% elif sortby == "2" %}
	A-Z
	{% elif sortby == "3" %}
	Z-A
	{% elif sortby == "4" %}
	Increasing visits
	{% elif sortby == "5" %}
	Decreasing visits
	{% endif %}
      </button>
      <div class="dropdown-menu">
	<a class="dropdown-item" href="javascript:change_sortby('0')">Newest first</a>
	<a class="dropdown-item" href="javascript:change_sortby('1')">Oldest first</a>
	<a class="dropdown-item" href="javascript:change_sortby('2')">A-Z</a>
	<a class="dropdown-item" href="javascript:change_sortby('3')">Z-A</a>
	<a class="dropdown-item" href="javascript:change_sortby('4')">Increasing visits</a>
	<a class="dropdown-item" href="javascript:change_sortby('5')">Decreasing visits</a>
      </div>
    </div>
  </div>

  {# My Links/All Links dropdown menu #}
  <div class="col col-md-auto">
    <div class="dropdown">
      <button class="btn btn-outline-primary btn-no-border btn-no-background dropdown-toggle bg-light"
	      type="button" data-toggle="dropdown"
	      aria-haspopup="true" aria-expanded="false">
	{{ selected_links_set }}
      </button>
      <div class="dropdown-menu">
	<a class="dropdown-item" href="javascript:change_links_set('GO!my')">My links</a>

	{% if "admin" in roles %}
	<a class="dropdown-item" href="javascript:change_links_set('GO!all')">All links</a>
	{% endif %}

	{% if orgs %}
	<div class="dropdown-divider"></div>
	{% for org in orgs %}
	<a class="dropdown-item" href="javascript:change_links_set('{{ org['name'] }}')">
	  {{ org['name'] }}
	</a>
	{% endfor %}
	{% endif %}
      </div>
    </div>
  </div>

  <div class="col col-csv-download">
    <form action="{{ url_for('stat.search-csv') }}">
      <button type="submit"
	      class="btn btn-outline-primary btn-no-border btn-no-background btn-csv-download bg-light">
	<i class="fas fa-download"></i> Export visits of search results as CSV
      </button>
    </form>
  </div>
</div>

{% if query and not links %}
<div class="row">
  <div class="col">
    <div class="shrunk-messages">
      No results found for query <strong>{{ query }}</strong>
    </div>
  </div>
</div>
{% endif %}

{% if links %}
<div class="container">
  {% for link in links %}
  {% include "link_card.html" %}
  {% endfor %}
</div>

{% if lastpage and lastpage > 1 %}
<nav aria-label="Search results pages">
  <ul class="pagination justify-content-center">
    <li class="page-item {{ 'disabled' if page == 1 else '' }}">
      <a class="page-link" aria-label="Previous"
	 href="{{ url_for('shrunk.render_index', page=page-1) }}">
	<span aria-hidden="true">&laquo;</span>
	<span class="sr-only">Previous</span>
      </a>
    </li>

    {% if begin_pages != 1 %}
    <li class="page-item">
      <a class="page-link" aria-label="Page 1"
	 href="{{ url_for('shrunk.render_index', page=1) }}">
	1
      </a>
    </li>

    <li class="page-item disabled">
      <a class="page-link" aria-label="Ellipsis">
	...
      </a>
    </li>
    {% endif %}

    {% for page_number in range(begin_pages, end_pages+1) %}
    {% set maybe_active = 'active' if page_number == page else '' %}
    <li class="page-item {{ maybe_active }}">
      <a class="page-link" aria-label="Page {{ page_number }}"
	 href="{{ url_for('shrunk.render_index', page=page_number) }}">
	{{ page_number }}
      </a>
    </li>
    {% endfor %}

    {% if end_pages != lastpage %}
    <li class="page-item disabled">
      <a class="page-link" aria-label="Ellipsis">
	...
      </a>
    </li>

    <li class="page-time">
      <a class="page-link" aria-label="Page {{ lastpage }}"
	 href="{{ url_for('shrunk.render_index', page=lastpage) }}">
	{{ lastpage }}
      </a>
    </li>
    {% endif %}

    <li class="page-item {{ 'disabled' if page == lastpage else '' }}">
      <a class="page-link" aria-label="Next"
	 href="{{ url_for('shrunk.render_index', page=page+1) }}">
	<span aria-hidden="true">&raquo;</span>
	<span class="sr-only">Next</span>
      </a>
    </li>
  </ul>
</nav>
{% endif %}

{% endif %}

<input type="hidden" id="link-delete-id">

<div id="link-delete-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
	<h4>Are you sure you want to delete this link?</h4>
	<button type="button" class="close" data-dismiss="modal" aria-label="Close">
	  <span aria-hidden="true">&times;</span>
	</button>
      </div>

      <div class="modal-body">
	This operation cannot be undone.

	<button type="button" class="btn btn-primary float-right" onclick="do_delete_link()">
	  Delete
	</button>

	<button type="button" class="btn btn-secondary float-right" data-dismiss="modal">
	  Cancel
	</button>
      </div>
    </div>
  </div>
</div>

<div id="link-edit-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header edit-link-modal-header">
	<h4 id="link-edit-modal-title"></h4>
	<button type="button" class="close" data-dismiss="modal" aria-label="Close">
	  <span aria-hidden="true">&times;</span>
	</button>
      </div>

      <div class="modal-body edit-link-modal-body">
	<form class="px-4 py-3 needs-validation" novalidate>
	  <input type="hidden" id="edit-link-old_short_url">
	  <div class="form-group row">
	    <input type="text" id="edit-link-title" class="form-control" placeholder="Title"
		   onkeydown="send_request_keypress(event, EDIT_LINK_FORM)">
	    <div id="edit-link-title-feedback" class="invalid-feedback"></div>
	  </div>
	  <div class="form-group row">
	    <input type="text" id="edit-link-long_url" class="form-control" placeholder="URL"
		   onkeydown="send_request_keypress(event, EDIT_LINK_FORM)">
	    <div id="edit-link-long_url-feedback" class="invalid-feedback"></div>
	  </div>
	  <div class="form-group row">
	    <input type="text" id="edit-link-short_url" class="form-control" placeholder="Alias"
		   onkeydown="send_request_keypress(event, EDIT_LINK_FORM)"
		   {% if "power_user" not in roles and "admin" not in roles %}
		   disabled
		   {% endif %}>
	    <div id="edit-link-short_url-feedback" class="invalid-feedback"></div>
	  </div>
	  <div class="row">
	    <div class="col">
	      <button class="btn btn-secondary edit-link-button" type="button" data-dismiss="modal">
		Cancel
	      </button>
	    </div>

	    <div class="col">
	      <button class="btn btn-primary edit-link-button" type="button"
		      onclick="send_request(EDIT_LINK_FORM)">
		Save
	      </button>
	    </div>
	  </div>
	</form>
      </div>
    </div>
  </div>
</div>

{% assets "shrunk_index" %}
<script src="{{ ASSET_URL }}"></script>
{% endassets %}

{% endblock %}
