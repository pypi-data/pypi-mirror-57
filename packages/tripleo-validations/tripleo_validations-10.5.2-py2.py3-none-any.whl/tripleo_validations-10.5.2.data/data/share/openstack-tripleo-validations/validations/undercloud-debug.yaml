---
- hosts: undercloud
  vars:
    metadata:
      name: Undercloud Services Debug Check
      description: >
        The undercloud's openstack services should _not_ have debug enabled.
        This will check if debug is enabled on undercloud services.
        If debug is enabled, the root filesystem can fill up quickly, and
        is not a good thing.
      groups:
        - pre-deployment
    debug_check: "True"
    services_conf_files:
      - /var/lib/config-data/puppet-generated/nova/etc/nova/nova.conf
      - /var/lib/config-data/puppet-generated/neutron/etc/neutron/neutron.conf
      - /var/lib/config-data/puppet-generated/ceilometer/etc/ceilometer/ceilometer.conf
      - /var/lib/config-data/puppet-generated/heat/etc/heat/heat.conf
      - /var/lib/config-data/puppet-generated/ironic/etc/ironic/ironic.conf
  tasks:
  - include_tasks: tasks/deprecation.yaml

  - name: Check the services for debug flag
    become: True
    ini:
      path: "{{ item }}"
      section: DEFAULT
      key: debug
      ignore_missing_file: True
    register: config_result
    with_items: "{{ services_conf_files }}"
    failed_when: "debug_check|bool  == config_result.value|bool"
