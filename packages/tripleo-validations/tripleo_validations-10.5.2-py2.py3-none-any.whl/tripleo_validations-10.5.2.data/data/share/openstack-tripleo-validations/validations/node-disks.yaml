---
- hosts: undercloud
  vars:
    metadata:
      name: Check node disk configuration
      description: >
        Check node disk numbers and sizes and whether root device hints are set.
      groups:
        - pre-deployment
      ironic_conf_file: "/var/lib/config-data/puppet-generated/ironic/etc/ironic/ironic.conf"
  tasks:
  - include_tasks: tasks/deprecation.yaml

  - name: Get Ironic Inspector swift auth_url
    become: true
    ini:
      path: "{{ ironic_conf_file }}"
      section: inspector
      key: auth_url
    register: ironic_auth_url

  - name: Get Ironic Inspector swift password
    become: true
    ini:
      path: "{{ ironic_conf_file }}"
      section: inspector
      key: password
    register: ironic_password

  - name: Check node disks
    node_disks:
      nodes: "{{ lookup('ironic_nodes', wantlist=True) }}"
      flavors: "{{ lookup('nova_flavors', wantlist=True) }}"
      introspection_data: "{{ lookup('introspection_data',
                              auth_url=ironic_auth_url.value,
                              password=ironic_password.value) }}"
