---
- hosts: undercloud
  vars:
    metadata:
      name: Check if latest minor version is installed
      description: >
        Makes sure python-tripleoclient is at its latest minor version
        before starting an upgrade.
      groups:
        - pre-upgrade
    packages:
      - python-tripleoclient
  tasks:
  - include_tasks: tasks/deprecation.yaml
  - name: Get available updates for packages
    check_package_update:
      package: "{{ item }}"
      pkg_mgr: "{{ ansible_pkg_mgr }}"
    with_items: "{{ packages }}"
    register: updates

  - name: Check if current version is latest minor
    with_items: "{{ updates.results }}"
    assert:
      that: "item.latest_minor_version == item.current_version"
      msg: >-
        "A newer version of the {{ item.name }} package is
        available: {{ item.latest_minor_version }} (currently
        {{ item.current_version }})."
